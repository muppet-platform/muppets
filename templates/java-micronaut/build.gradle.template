plugins {
    id 'com.github.johnrengelman.shadow' version '7.1.2'
    id 'io.micronaut.application' version '4.4.4'
    id 'jacoco'
    id 'com.diffplug.spotless' version '6.25.0'
}

version = "1.0.0"
group = "com.muppetplatform.{{java_package_name}}"

repositories {
    mavenCentral()
}

dependencies {
    // Micronaut Core
    implementation 'io.micronaut:micronaut-http-client'
    implementation 'io.micronaut:micronaut-http-server-netty'
    implementation 'io.micronaut:micronaut-jackson-databind'
    implementation 'io.micronaut.validation:micronaut-validation'
    
    // YAML Configuration
    runtimeOnly 'org.yaml:snakeyaml'
    
    // Metrics and Monitoring (CloudWatch disabled for local development)
    implementation 'io.micronaut.micrometer:micronaut-micrometer-core'
    // CloudWatch metrics - uncomment for production deployment
    // implementation 'io.micronaut.micrometer:micronaut-micrometer-registry-cloudwatch'
    
    // Logging
    implementation 'ch.qos.logback:logback-classic'
    implementation 'net.logstash.logback:logstash-logback-encoder:7.4'
    // CloudWatch logging - uncomment for production deployment  
    // implementation 'ca.pjer:logback-awslogs-appender:1.6.0'
    
    // AWS SDK (commented out for local development)
    // implementation 'software.amazon.awssdk:cloudwatch:2.21.29'
    
    // Testing
    testImplementation 'io.micronaut:micronaut-http-client'
    testImplementation 'io.micronaut.test:micronaut-test-junit5'
    testImplementation 'org.junit.jupiter:junit-jupiter-api'
    testImplementation 'org.junit.jupiter:junit-jupiter-engine'
    testImplementation 'org.mockito:mockito-core'
    
    // Annotation Processing
    annotationProcessor 'io.micronaut:micronaut-http-validation'
    annotationProcessor 'io.micronaut.validation:micronaut-validation-processor'
}

application {
    mainClass = 'com.muppetplatform.{{java_package_name}}.Application'
}

java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
}

micronaut {
    runtime 'netty'
    testRuntime 'junit5'
    processing {
        incremental true
        annotations 'com.muppetplatform.{{java_package_name}}.*'
    }
}

tasks.named("test") {
    useJUnitPlatform()
    testLogging {
        events "passed", "skipped", "failed"
    }
}

tasks.named("shadowJar") {
    mergeServiceFiles()
}

jacoco {
    toolVersion = "0.8.11"
}

jacocoTestReport {
    dependsOn test
    reports {
        xml.required = true
        html.required = true
    }
    finalizedBy jacocoTestCoverageVerification
}

jacocoTestCoverageVerification {
    violationRules {
        rule {
            limit {
                minimum = 0.80
            }
        }
    }
}

test.finalizedBy jacocoTestReport

spotless {
    java {
        target 'src/**/*.java'
        googleJavaFormat('1.19.1').aosp().reflowLongStrings()
        removeUnusedImports()
        trimTrailingWhitespace()
        endWithNewline()
    }
    
    format 'misc', {
        target '*.gradle', '*.md', '.gitignore'
        trimTrailingWhitespace()
        indentWithSpaces(4)
        endWithNewline()
    }
}

// Configure Spotless to only run during explicit check, not during build
// This prevents formatting issues from breaking Docker builds
// Developers should run 'make format' or './gradlew spotlessApply' to fix formatting
gradle.taskGraph.whenReady { taskGraph ->
    if (taskGraph.hasTask(tasks.build) && !taskGraph.hasTask(tasks.check)) {
        tasks.spotlessCheck.enabled = false
    }
}
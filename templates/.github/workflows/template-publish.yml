name: Template Publishing

on:
  push:
    branches: [ main ]
    tags:
      - 'template-*'
  workflow_dispatch:
    inputs:
      template_name:
        description: 'Template to publish'
        required: true
        type: choice
        options:
        - java-micronaut
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major

env:
  JAVA_VERSION: "21"
  JAVA_DISTRIBUTION: "corretto"

jobs:
  validate-before-publish:
    name: Validate Before Publishing
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Amazon Corretto JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.JAVA_DISTRIBUTION }}
        
    - name: Run comprehensive template validation
      run: |
        # Run all template tests
        for template_dir in templates/*/; do
          if [ -d "$template_dir" ] && [ "$(basename "$template_dir")" != "tests" ] && [ "$(basename "$template_dir")" != "template-tools" ]; then
            template_name=$(basename "$template_dir")
            echo "Validating $template_name..."
            
            if [ -f "$template_dir/tests/test-template.sh" ]; then
              cd "$template_dir/tests"
              chmod +x test-template.sh
              ./test-template.sh
              cd - > /dev/null
            else
              echo "⚠️  No comprehensive test found for $template_name"
            fi
          fi
        done

  publish-templates:
    name: Publish Templates
    runs-on: ubuntu-latest
    needs: validate-before-publish
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/template-')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for versioning
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        
    - name: Install publishing tools
      run: |
        pip install pyyaml semver
        
    - name: Determine templates to publish
      id: templates
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "templates=${{ github.event.inputs.template_name }}" >> $GITHUB_OUTPUT
        else
          # Auto-detect changed templates
          changed_templates=""
          for template_dir in templates/*/; do
            if [ -d "$template_dir" ] && [ "$(basename "$template_dir")" != "tests" ] && [ "$(basename "$template_dir")" != "template-tools" ]; then
              template_name=$(basename "$template_dir")
              
              # Check if template has changes since last tag
              if git diff --name-only HEAD~1 HEAD | grep -q "^templates/$template_name/"; then
                if [ -n "$changed_templates" ]; then
                  changed_templates="$changed_templates,$template_name"
                else
                  changed_templates="$template_name"
                fi
              fi
            fi
          done
          
          echo "templates=$changed_templates" >> $GITHUB_OUTPUT
        fi
        
    - name: Update template versions
      if: steps.templates.outputs.templates != ''
      run: |
        IFS=',' read -ra TEMPLATES <<< "${{ steps.templates.outputs.templates }}"
        
        for template_name in "${TEMPLATES[@]}"; do
          if [ -n "$template_name" ]; then
            template_file="templates/$template_name/template.yaml"
            
            if [ -f "$template_file" ]; then
              echo "Updating version for $template_name..."
              
              # Get current version
              current_version=$(python3 -c "
              import yaml
              with open('$template_file', 'r') as f:
                  template = yaml.safe_load(f)
              print(template.get('version', '0.1.0'))
              ")
              
              # Determine version bump
              if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                bump_type="${{ github.event.inputs.version_bump }}"
              else
                bump_type="patch"  # Default for automatic publishing
              fi
              
              # Calculate new version
              new_version=$(python3 -c "
              import semver
              current = '$current_version'
              bump = '$bump_type'
              
              # Parse current version
              try:
                  version_info = semver.VersionInfo.parse(current)
                  if bump == 'major':
                      new_version = str(version_info.bump_major())
                  elif bump == 'minor':
                      new_version = str(version_info.bump_minor())
                  else:
                      new_version = str(version_info.bump_patch())
                  print(new_version)
              except:
                  # Fallback for invalid semver
                  parts = current.split('.')
                  if len(parts) != 3:
                      parts = ['0', '1', '0']
                  
                  major, minor, patch = map(int, parts)
                  if bump == 'major':
                      major += 1
                      minor = 0
                      patch = 0
                  elif bump == 'minor':
                      minor += 1
                      patch = 0
                  else:
                      patch += 1
                  
                  print(f'{major}.{minor}.{patch}')
              ")
              
              # Update template.yaml
              python3 -c "
              import yaml
              with open('$template_file', 'r') as f:
                  template = yaml.safe_load(f)
              
              template['version'] = '$new_version'
              template['updated_at'] = '$(date -u +%Y-%m-%dT%H:%M:%SZ)'
              
              with open('$template_file', 'w') as f:
                  yaml.dump(template, f, default_flow_style=False, sort_keys=False)
              "
              
              echo "Updated $template_name from $current_version to $new_version"
              echo "${template_name}_version=$new_version" >> $GITHUB_ENV
            fi
          fi
        done
        
    - name: Create template archives
      if: steps.templates.outputs.templates != ''
      run: |
        mkdir -p dist/templates
        
        IFS=',' read -ra TEMPLATES <<< "${{ steps.templates.outputs.templates }}"
        
        for template_name in "${TEMPLATES[@]}"; do
          if [ -n "$template_name" ]; then
            template_dir="templates/$template_name"
            
            if [ -d "$template_dir" ]; then
              echo "Creating archive for $template_name..."
              
              # Get version from environment variable
              version_var="${template_name}_version"
              version="${!version_var}"
              
              if [ -z "$version" ]; then
                # Fallback to reading from template.yaml
                version=$(python3 -c "
                import yaml
                with open('$template_dir/template.yaml', 'r') as f:
                    template = yaml.safe_load(f)
                print(template.get('version', '0.1.0'))
                ")
              fi
              
              archive_name="$template_name-$version.tar.gz"
              
              # Create archive excluding test files and .git
              tar -czf "dist/templates/$archive_name" \
                --exclude="tests/" \
                --exclude=".git*" \
                --exclude="*.log" \
                --exclude="target/" \
                --exclude="build/" \
                --exclude="node_modules/" \
                -C templates "$template_name"
              
              echo "Created archive: $archive_name"
              
              # Create metadata file
              cat > "dist/templates/$template_name-$version.json" << EOF
              {
                "name": "$template_name",
                "version": "$version",
                "archive": "$archive_name",
                "published_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                "git_commit": "${{ github.sha }}",
                "git_ref": "${{ github.ref }}"
              }
              EOF
            fi
          fi
        done
        
    - name: Upload template artifacts
      if: steps.templates.outputs.templates != ''
      uses: actions/upload-artifact@v3
      with:
        name: template-archives
        path: dist/templates/
        retention-days: 90
        
    - name: Create GitHub release
      if: steps.templates.outputs.templates != '' && github.ref == 'refs/heads/main'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          const templates = '${{ steps.templates.outputs.templates }}';
          if (!templates) return;
          
          const templateList = templates.split(',').filter(t => t.trim());
          
          let releaseBody = '## Template Updates\n\n';
          let releaseTitle = 'Template Release';
          
          for (const templateName of templateList) {
            const versionVar = `${templateName}_version`;
            const version = process.env[versionVar];
            
            if (version) {
              releaseBody += `- **${templateName}**: v${version}\n`;
              releaseTitle = templateList.length === 1 ? 
                `${templateName} v${version}` : 
                `Templates Release ${new Date().toISOString().split('T')[0]}`;
            }
          }
          
          releaseBody += '\n### Changes\n\n';
          releaseBody += 'See commit history for detailed changes.\n';
          
          const tag = `templates-${new Date().toISOString().split('T')[0]}-${context.sha.substring(0, 7)}`;
          
          await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: tag,
            name: releaseTitle,
            body: releaseBody,
            draft: false,
            prerelease: false
          });
          
    - name: Commit version updates
      if: steps.templates.outputs.templates != ''
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        IFS=',' read -ra TEMPLATES <<< "${{ steps.templates.outputs.templates }}"
        
        for template_name in "${TEMPLATES[@]}"; do
          if [ -n "$template_name" ]; then
            git add "templates/$template_name/template.yaml"
          fi
        done
        
        if ! git diff --staged --quiet; then
          git commit -m "chore: update template versions [skip ci]"
          git push
        fi

  notify-platform:
    name: Notify Platform of Template Updates
    runs-on: ubuntu-latest
    needs: publish-templates
    if: success()
    
    steps:
    - name: Trigger platform template cache refresh
      run: |
        # This would trigger the platform to refresh its template cache
        # For now, we'll just create a notification
        echo "Template publishing completed. Platform should refresh template cache."
        
        # In a real implementation, this might:
        # 1. Call a platform API endpoint to refresh templates
        # 2. Update a shared configuration
        # 3. Trigger a platform deployment with new template versions
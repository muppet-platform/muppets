name: Maintenance

on:
  schedule:
    # Run weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      task:
        description: 'Maintenance task to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - dependencies
        - security
        - cleanup
        - docs

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Update Dependencies
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.task == 'all' || github.event.inputs.task == 'dependencies'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: Update Python dependencies
      run: |
        cd platform
        
        # Update dependencies
        uv sync --upgrade
        
        # Check for outdated packages
        uv pip list --outdated > outdated-packages.txt || true
        
        if [ -s outdated-packages.txt ]; then
          echo "ðŸ“¦ Outdated packages found:"
          cat outdated-packages.txt
        else
          echo "âœ… All packages are up to date"
        fi
        
    - name: Run tests after dependency update
      run: |
        cd platform
        uv run pytest tests/ -v --tb=short
        
    - name: Check for security vulnerabilities
      run: |
        cd platform
        uv run safety check || true
        
    - name: Create dependency update PR
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update Python dependencies'
        title: 'ðŸ”„ Weekly Dependency Update'
        body: |
          ## Dependency Update
          
          This PR updates Python dependencies to their latest versions.
          
          ### Changes
          - Updated `uv.lock` with latest package versions
          - Verified all tests still pass
          - Checked for security vulnerabilities
          
          ### Verification
          - âœ… All tests passing
          - âœ… Security scan completed
          
          This PR was automatically created by the maintenance workflow.
        branch: maintenance/dependency-update
        delete-branch: true

  # Job 2: Security Maintenance
  security-maintenance:
    name: Security Maintenance
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.task == 'all' || github.event.inputs.task == 'security'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: Install dependencies
      run: |
        cd platform
        uv sync --dev
        
    - name: Run comprehensive security scan
      run: |
        cd platform
        
        echo "ðŸ” Running security scans..."
        
        # Safety check for known vulnerabilities
        echo "## Safety Check" > security-report.md
        uv run safety check --json --output safety.json || true
        if [ -f safety.json ]; then
          echo "```json" >> security-report.md
          cat safety.json >> security-report.md
          echo "```" >> security-report.md
        fi
        echo "" >> security-report.md
        
        # Bandit for code security issues
        echo "## Bandit Scan" >> security-report.md
        uv run bandit -r src/ -f json -o bandit.json || true
        if [ -f bandit.json ]; then
          echo "```json" >> security-report.md
          head -50 bandit.json >> security-report.md
          echo "```" >> security-report.md
        fi
        
    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: weekly-security-report
        path: platform/security-report.md
        retention-days: 30
        
    - name: Create security issue if vulnerabilities found
      run: |
        cd platform
        
        # Check if there are any high-severity issues
        SAFETY_ISSUES=$(cat safety.json 2>/dev/null | jq '.vulnerabilities | length' || echo "0")
        BANDIT_HIGH=$(cat bandit.json 2>/dev/null | jq '[.results[] | select(.issue_severity == "HIGH")] | length' || echo "0")
        
        if [ "$SAFETY_ISSUES" -gt 0 ] || [ "$BANDIT_HIGH" -gt 0 ]; then
          echo "ðŸš¨ Security vulnerabilities found!"
          echo "Safety issues: $SAFETY_ISSUES"
          echo "Bandit high severity: $BANDIT_HIGH"
          
          # Create GitHub issue (would need additional setup)
          echo "Would create security issue here"
        else
          echo "âœ… No high-severity security issues found"
        fi

  # Job 3: Cleanup Old Artifacts
  cleanup-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.task == 'all' || github.event.inputs.task == 'cleanup'
    permissions:
      actions: write
    
    steps:
    - name: Cleanup old workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 30
        keep_minimum_runs: 10
        
    - name: Cleanup old artifacts
      run: |
        echo "ðŸ§¹ Cleaning up old artifacts..."
        
        # Get list of old artifacts (older than 30 days)
        OLD_ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/artifacts \
          --jq '.artifacts[] | select(.created_at < (now - 30*24*3600 | strftime("%Y-%m-%dT%H:%M:%SZ"))) | .id')
        
        if [ -n "$OLD_ARTIFACTS" ]; then
          echo "Found old artifacts to delete:"
          echo "$OLD_ARTIFACTS"
          
          # Delete old artifacts
          echo "$OLD_ARTIFACTS" | while read -r artifact_id; do
            gh api repos/${{ github.repository }}/actions/artifacts/$artifact_id -X DELETE
            echo "Deleted artifact $artifact_id"
          done
        else
          echo "No old artifacts to delete"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 4: Documentation Maintenance
  docs-maintenance:
    name: Documentation Maintenance
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.task == 'all' || github.event.inputs.task == 'docs'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: Update documentation
      run: |
        echo "ðŸ“š Updating documentation..."
        
        # Update README badges and links
        sed -i 's/\(!\[.*\].*\)main/\1main/g' README.md
        
        # Update version references in documentation
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.0")
        find docs/ -name "*.md" -exec sed -i "s/version-[0-9]\+\.[0-9]\+\.[0-9]\+/version-${LATEST_TAG#v}/g" {} \;
        
        # Generate API documentation
        cd platform
        uv sync --dev
        
        # Generate OpenAPI spec
        uv run python -c "
        from src.main import app
        import json
        
        openapi_spec = app.openapi()
        with open('../docs/api-spec.json', 'w') as f:
            json.dump(openapi_spec, f, indent=2)
        "
        
        echo "âœ… Documentation updated"
        
    - name: Check for broken links
      run: |
        echo "ðŸ”— Checking for broken links..."
        
        # Install markdown-link-check
        npm install -g markdown-link-check
        
        # Check all markdown files
        find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" | \
          xargs markdown-link-check --config .github/markdown-link-check.json || true
        
    - name: Commit documentation updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "No documentation changes to commit"
        else
          git add .
          git commit -m "docs: automated documentation maintenance"
          git push
        fi

  # Job 5: Health Check Summary
  health-summary:
    name: Health Check Summary
    runs-on: ubuntu-latest
    needs: [update-dependencies, security-maintenance, cleanup-artifacts, docs-maintenance]
    if: always()
    
    steps:
    - name: Generate maintenance summary
      run: |
        echo "# Weekly Maintenance Summary" > maintenance-summary.md
        echo "" >> maintenance-summary.md
        echo "Generated on: $(date -u)" >> maintenance-summary.md
        echo "" >> maintenance-summary.md
        
        echo "## Job Results" >> maintenance-summary.md
        echo "" >> maintenance-summary.md
        
        if [ "${{ needs.update-dependencies.result }}" = "success" ]; then
          echo "âœ… Dependency Updates: COMPLETED" >> maintenance-summary.md
        elif [ "${{ needs.update-dependencies.result }}" = "skipped" ]; then
          echo "â­ï¸ Dependency Updates: SKIPPED" >> maintenance-summary.md
        else
          echo "âŒ Dependency Updates: FAILED" >> maintenance-summary.md
        fi
        
        if [ "${{ needs.security-maintenance.result }}" = "success" ]; then
          echo "âœ… Security Maintenance: COMPLETED" >> maintenance-summary.md
        elif [ "${{ needs.security-maintenance.result }}" = "skipped" ]; then
          echo "â­ï¸ Security Maintenance: SKIPPED" >> maintenance-summary.md
        else
          echo "âŒ Security Maintenance: FAILED" >> maintenance-summary.md
        fi
        
        if [ "${{ needs.cleanup-artifacts.result }}" = "success" ]; then
          echo "âœ… Artifact Cleanup: COMPLETED" >> maintenance-summary.md
        elif [ "${{ needs.cleanup-artifacts.result }}" = "skipped" ]; then
          echo "â­ï¸ Artifact Cleanup: SKIPPED" >> maintenance-summary.md
        else
          echo "âŒ Artifact Cleanup: FAILED" >> maintenance-summary.md
        fi
        
        if [ "${{ needs.docs-maintenance.result }}" = "success" ]; then
          echo "âœ… Documentation Maintenance: COMPLETED" >> maintenance-summary.md
        elif [ "${{ needs.docs-maintenance.result }}" = "skipped" ]; then
          echo "â­ï¸ Documentation Maintenance: SKIPPED" >> maintenance-summary.md
        else
          echo "âŒ Documentation Maintenance: FAILED" >> maintenance-summary.md
        fi
        
        echo "" >> maintenance-summary.md
        echo "## Next Steps" >> maintenance-summary.md
        echo "" >> maintenance-summary.md
        echo "- Review any created pull requests" >> maintenance-summary.md
        echo "- Check security reports for vulnerabilities" >> maintenance-summary.md
        echo "- Verify documentation updates" >> maintenance-summary.md
        
        cat maintenance-summary.md
        
    - name: Upload maintenance summary
      uses: actions/upload-artifact@v4
      with:
        name: maintenance-summary
        path: maintenance-summary.md
        retention-days: 90
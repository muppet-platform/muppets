name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Essential Job 1: Tests & Quality (Combined)
  tests-and-quality:
    name: Tests & Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: Install dependencies
      run: |
        cd platform
        uv sync --dev
        
    - name: Run tests
      run: |
        cd platform
        uv run pytest tests/ -v --tb=short
        
    - name: Check code formatting
      run: |
        cd platform
        uv run black --check src/ tests/
        
    - name: Check import sorting
      run: |
        cd platform
        uv run isort --check-only src/ tests/

  # Essential Job 2: Template Validation
  template-validation:
    name: Template Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Java (Amazon Corretto 21 LTS)
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'corretto'
        
    - name: Verify Java version
      run: |
        java -version 2>&1 | grep -q "21.*LTS" && echo "✅ Java 21 LTS detected" || (echo "❌ Non-LTS Java version detected" && exit 1)
        
    - name: Validate template files
      run: |
        cd templates/java-micronaut
        test -f Dockerfile.template
        test -f build.gradle.template
        test -f template.yaml
        test -f .env.local
        echo "✅ Template files validated"
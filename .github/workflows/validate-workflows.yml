name: Validate Workflows

on:
  push:
    paths:
      - '.github/workflows/**'
      - 'scripts/**'
  pull_request:
    paths:
      - '.github/workflows/**'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  # Job 1: Validate Workflow Syntax
  validate-syntax:
    name: Validate Workflow Syntax
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate workflow files
      run: |
        echo "üîç Validating GitHub Actions workflow syntax..."
        
        # Check for syntax errors in workflow files
        for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
          if [ -f "$workflow" ]; then
            echo "Validating $workflow..."
            
            # Basic YAML syntax check
            python3 -c "
import yaml
import sys
try:
    with open('$workflow', 'r') as f:
        yaml.safe_load(f)
    print('‚úÖ $workflow: Valid YAML syntax')
except yaml.YAMLError as e:
    print('‚ùå $workflow: Invalid YAML syntax')
    print(e)
    sys.exit(1)
except Exception as e:
    print('‚ùå $workflow: Error reading file')
    print(e)
    sys.exit(1)
"
          fi
        done
        
        echo "‚úÖ All workflow files have valid syntax"

  # Job 2: Validate Script Dependencies
  validate-scripts:
    name: Validate Script Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check script executability
      run: |
        echo "üîç Checking script permissions and dependencies..."
        
        # Check that all scripts are executable
        for script in scripts/*.sh; do
          if [ -f "$script" ]; then
            if [ ! -x "$script" ]; then
              echo "‚ùå $script is not executable"
              chmod +x "$script"
              echo "‚úÖ Fixed permissions for $script"
            else
              echo "‚úÖ $script is executable"
            fi
          fi
        done
        
        # Check for shell script syntax
        for script in scripts/*.sh; do
          if [ -f "$script" ]; then
            echo "Validating $script..."
            bash -n "$script" && echo "‚úÖ $script: Valid bash syntax" || (echo "‚ùå $script: Invalid bash syntax" && exit 1)
          fi
        done

  # Job 3: Validate Action Versions
  validate-action-versions:
    name: Validate Action Versions
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for outdated actions
      run: |
        echo "üîç Checking for outdated GitHub Actions..."
        
        # Extract action versions from workflow files
        grep -r "uses:" .github/workflows/ | grep -v "# " | sort | uniq > used-actions.txt
        
        echo "Currently used actions:"
        cat used-actions.txt
        
        # Check for common outdated patterns
        echo ""
        echo "üîç Checking for potentially outdated actions..."
        
        if grep -q "actions/checkout@v3" used-actions.txt; then
          echo "‚ö†Ô∏è  Found actions/checkout@v3 - consider upgrading to v4"
        fi
        
        if grep -q "actions/setup-python@v3" used-actions.txt; then
          echo "‚ö†Ô∏è  Found actions/setup-python@v3 - consider upgrading to v4"
        fi
        
        if grep -q "actions/setup-java@v3" used-actions.txt; then
          echo "‚ö†Ô∏è  Found actions/setup-java@v3 - consider upgrading to v4"
        fi
        
        echo "‚úÖ Action version check completed"

  # Job 4: Validate Environment Configuration
  validate-environment:
    name: Validate Environment Configuration
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check required environment variables
      run: |
        echo "üîç Validating environment configuration..."
        
        # Check for required environment variables in workflows
        REQUIRED_VARS=(
          "PYTHON_VERSION"
          "UV_VERSION"
          "REGISTRY"
          "IMAGE_NAME"
        )
        
        for var in "${REQUIRED_VARS[@]}"; do
          if grep -r "$var" .github/workflows/ > /dev/null; then
            echo "‚úÖ Found usage of $var in workflows"
          else
            echo "‚ö†Ô∏è  $var not found in workflows - may need to be added"
          fi
        done
        
        # Check for hardcoded values that should be variables
        echo ""
        echo "üîç Checking for hardcoded values..."
        
        if grep -r "python.*3\.11" .github/workflows/ > /dev/null; then
          echo "‚úÖ Python version is properly referenced"
        fi
        
        if grep -r "java.*21" .github/workflows/ > /dev/null; then
          echo "‚úÖ Java version is properly referenced"
        fi
        
        echo "‚úÖ Environment configuration check completed"

  # Job 5: Test Workflow Triggers
  test-triggers:
    name: Test Workflow Triggers
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate workflow triggers
      run: |
        echo "üîç Validating workflow triggers..."
        
        # Check that CI workflow has proper triggers
        if grep -A 10 "^on:" .github/workflows/ci.yml | grep -q "push:"; then
          echo "‚úÖ CI workflow has push trigger"
        else
          echo "‚ùå CI workflow missing push trigger"
          exit 1
        fi
        
        if grep -A 10 "^on:" .github/workflows/ci.yml | grep -q "pull_request:"; then
          echo "‚úÖ CI workflow has pull_request trigger"
        else
          echo "‚ùå CI workflow missing pull_request trigger"
          exit 1
        fi
        
        # Check that CD workflow has proper triggers
        if grep -A 10 "^on:" .github/workflows/cd.yml | grep -q "push:"; then
          echo "‚úÖ CD workflow has push trigger"
        else
          echo "‚ùå CD workflow missing push trigger"
          exit 1
        fi
        
        # Check that security workflow has schedule trigger
        if grep -A 10 "^on:" .github/workflows/security.yml | grep -q "schedule:"; then
          echo "‚úÖ Security workflow has schedule trigger"
        else
          echo "‚ùå Security workflow missing schedule trigger"
          exit 1
        fi
        
        echo "‚úÖ Workflow trigger validation completed"

  # Job 6: Validate Dependencies
  validate-dependencies:
    name: Validate Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check job dependencies
      run: |
        echo "üîç Validating job dependencies..."
        
        # Extract job dependencies from CI workflow
        python3 << 'EOF'
        import yaml
        import sys
        
        try:
            with open('.github/workflows/ci.yml', 'r') as f:
                ci_workflow = yaml.safe_load(f)
            
            jobs = ci_workflow.get('jobs', {})
            
            # Check for circular dependencies
            dependencies = {}
            for job_name, job_config in jobs.items():
                needs = job_config.get('needs', [])
                if isinstance(needs, str):
                    needs = [needs]
                dependencies[job_name] = needs
            
            print("Job dependencies:")
            for job, deps in dependencies.items():
                if deps:
                    print(f"  {job} depends on: {', '.join(deps)}")
                else:
                    print(f"  {job} has no dependencies")
            
            # Validate that all dependencies exist
            all_jobs = set(jobs.keys())
            for job_name, deps in dependencies.items():
                for dep in deps:
                    if dep not in all_jobs:
                        print(f"‚ùå Job '{job_name}' depends on non-existent job '{dep}'")
                        sys.exit(1)
            
            print("‚úÖ All job dependencies are valid")
            
        except Exception as e:
            print(f"‚ùå Error validating dependencies: {e}")
            sys.exit(1)
        EOF

  # Job 7: Summary
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-syntax, validate-scripts, validate-action-versions, validate-environment, test-triggers, validate-dependencies]
    if: always()
    
    steps:
    - name: Generate validation summary
      run: |
        echo "# Workflow Validation Summary" > validation-summary.md
        echo "" >> validation-summary.md
        echo "Generated on: $(date -u)" >> validation-summary.md
        echo "" >> validation-summary.md
        
        echo "## Validation Results" >> validation-summary.md
        echo "" >> validation-summary.md
        
        if [ "${{ needs.validate-syntax.result }}" = "success" ]; then
          echo "‚úÖ Workflow Syntax: PASSED" >> validation-summary.md
        else
          echo "‚ùå Workflow Syntax: FAILED" >> validation-summary.md
        fi
        
        if [ "${{ needs.validate-scripts.result }}" = "success" ]; then
          echo "‚úÖ Script Validation: PASSED" >> validation-summary.md
        else
          echo "‚ùå Script Validation: FAILED" >> validation-summary.md
        fi
        
        if [ "${{ needs.validate-action-versions.result }}" = "success" ]; then
          echo "‚úÖ Action Versions: PASSED" >> validation-summary.md
        else
          echo "‚ùå Action Versions: FAILED" >> validation-summary.md
        fi
        
        if [ "${{ needs.validate-environment.result }}" = "success" ]; then
          echo "‚úÖ Environment Config: PASSED" >> validation-summary.md
        else
          echo "‚ùå Environment Config: FAILED" >> validation-summary.md
        fi
        
        if [ "${{ needs.test-triggers.result }}" = "success" ]; then
          echo "‚úÖ Workflow Triggers: PASSED" >> validation-summary.md
        else
          echo "‚ùå Workflow Triggers: FAILED" >> validation-summary.md
        fi
        
        if [ "${{ needs.validate-dependencies.result }}" = "success" ]; then
          echo "‚úÖ Job Dependencies: PASSED" >> validation-summary.md
        else
          echo "‚ùå Job Dependencies: FAILED" >> validation-summary.md
        fi
        
        echo "" >> validation-summary.md
        echo "## Next Steps" >> validation-summary.md
        echo "" >> validation-summary.md
        echo "- Review any failed validations above" >> validation-summary.md
        echo "- Update outdated actions if found" >> validation-summary.md
        echo "- Fix any syntax or dependency issues" >> validation-summary.md
        echo "- Test workflows in feature branches before merging" >> validation-summary.md
        
        cat validation-summary.md
        
    - name: Upload validation summary
      uses: actions/upload-artifact@v4
      with:
        name: workflow-validation-summary
        path: validation-summary.md
        retention-days: 30
# Infrastructure Template Consolidation Plan

## Problem Statement

Currently, we have infrastructure templates in two locations:
1. `templates/java-micronaut/terraform/` - Static template files
2. `platform/infrastructure-templates/` - Dynamic template files used by Auto-Generator

This creates duplication, potential inconsistency, and unclear ownership.

## Recommended Solution: Platform-Centric with Template Extension Points

### Design Principle
**"Platform-Managed Infrastructure with Template Extension Points"**

- **Platform owns**: Security, networking, monitoring, TLS, compliance standards
- **Templates provide**: Language-specific optimizations, runtime configurations, application-specific settings
- **Single source of truth**: All infrastructure templates in `platform/infrastructure-templates/`
- **Extension mechanism**: Templates can contribute additional configurations without overriding platform standards

### Target Architecture

```
platform/infrastructure-templates/
├── base/                           # Platform-managed base infrastructure
│   ├── main.tf.template           # Core infrastructure (VPC, ALB, ECR, Security)
│   ├── variables.tf.template      # Standard variables with validation
│   ├── outputs.tf.template        # Standard outputs
│   └── versions.tf.template       # Provider requirements
├── shared/                         # Reusable infrastructure patterns
│   ├── tls.tf.template            # TLS certificate management
│   ├── monitoring.tf.template     # Base monitoring configuration
│   └── security.tf.template       # Security baseline
├── java/                          # Java-specific infrastructure
│   ├── fargate-java.tf.template   # Java-optimized Fargate configuration
│   ├── monitoring-java.tf.template # JVM-specific monitoring
│   └── variables-java.tf.template # Java-specific variables
├── python/                        # Python-specific infrastructure (future)
├── nodejs/                        # Node.js-specific infrastructure (future)
└── config.yaml                   # Template configuration and rules

templates/java-micronaut/
├── src/                           # Application code
├── .github/                       # CI/CD workflows
├── .kiro/                         # Kiro configuration
├── template.yaml                  # Template metadata
└── terraform/                     # REMOVED - Generated by platform
```

### Migration Plan

#### Phase 1: Consolidate Infrastructure Templates
1. **Move existing terraform files** from `templates/java-micronaut/terraform/` to `platform/infrastructure-templates/base/`
2. **Enhance with platform standards** (TLS, security, monitoring)
3. **Create Java-specific optimizations** in `platform/infrastructure-templates/java/`
4. **Update Auto-Generator** to use consolidated templates
5. **Remove duplicate files** from template directories

#### Phase 2: Template Extension Mechanism
1. **Define extension points** in base templates
2. **Create template contribution system** for language-specific additions
3. **Implement validation** to ensure template contributions don't break platform standards
4. **Add template testing** for infrastructure generation

#### Phase 3: Template Developer Experience
1. **Create infrastructure preview tools** for template developers
2. **Add infrastructure documentation generation** from templates
3. **Implement infrastructure diff tools** to show changes between template versions
4. **Create infrastructure testing framework** for template validation

### Benefits

#### For Platform Team
- **Single source of truth** for infrastructure standards
- **Consistent security and compliance** across all templates
- **Easier to evolve infrastructure patterns** without updating multiple templates
- **Better control over cost optimization** and operational excellence

#### For Template Developers
- **Focus on application concerns** rather than infrastructure complexity
- **Automatic compliance** with platform standards
- **Language-specific optimizations** without infrastructure expertise
- **Reduced maintenance burden** for infrastructure updates

#### For Muppet Developers
- **Consistent infrastructure experience** across all templates
- **Production-ready defaults** with security and monitoring built-in
- **Predictable resource allocation** and cost patterns
- **Simplified troubleshooting** with standardized infrastructure

### Implementation Details

#### Template Configuration System
```yaml
# platform/infrastructure-templates/config.yaml
templates:
  java:
    base_templates:
      - base/main.tf.template
      - base/variables.tf.template
      - base/outputs.tf.template
      - base/versions.tf.template
    
    language_templates:
      - java/fargate-java.tf.template
      - java/monitoring-java.tf.template
      - java/variables-java.tf.template
    
    variables:
      java_cpu: 1024
      java_memory: 2048
      java_version: "21"
      enable_jvm_metrics: true
    
    validation_rules:
      - java_version_must_be_lts: true
      - min_memory_for_jvm: 2048
      - required_health_checks: ["/health", "/health/readiness"]

platform_standards:
  security:
    tls_required: true
    waf_enabled: true
    security_headers: true
  
  monitoring:
    cloudwatch_required: true
    log_retention_days: 7
    alarms_enabled: true
  
  compliance:
    cost_optimization: true
    multi_az_required: true
    backup_required: false  # For stateless services
```

#### Extension Point System
Templates can contribute additional infrastructure through extension points:

```hcl
# In base/main.tf.template
{{#template_extensions}}
# Template-specific extensions
{{#each extensions}}
{{> this}}
{{/each}}
{{/template_extensions}}
```

#### Template Contribution Validation
```python
class TemplateContributionValidator:
    def validate_contribution(self, contribution: Dict[str, Any]) -> ValidationResult:
        # Ensure contributions don't override platform standards
        # Validate resource naming conventions
        # Check for security compliance
        # Verify cost optimization settings
```

### Migration Steps

#### Step 1: Audit Current Infrastructure
- [ ] Catalog all infrastructure files in `templates/java-micronaut/terraform/`
- [ ] Identify platform standards vs. template-specific configurations
- [ ] Document current resource allocation and optimization patterns
- [ ] List security and compliance requirements

#### Step 2: Create Consolidated Templates
- [ ] Move base infrastructure to `platform/infrastructure-templates/base/`
- [ ] Extract Java-specific optimizations to `platform/infrastructure-templates/java/`
- [ ] Enhance with missing platform standards (TLS, comprehensive monitoring, security)
- [ ] Create configuration system for template management

#### Step 3: Update Auto-Generator
- [ ] Modify `InfrastructureTemplateProcessor` to use consolidated templates
- [ ] Remove old template processing logic
- [ ] Add validation for template contributions
- [ ] Update tests to use new template structure

#### Step 4: Clean Up Template Directories
- [ ] Remove `terraform/` directories from template folders
- [ ] Update template documentation
- [ ] Update template validation scripts
- [ ] Create migration guide for template developers

#### Step 5: Validation and Testing
- [ ] Run comprehensive tests with consolidated templates
- [ ] Validate generated infrastructure matches current output
- [ ] Test with multiple template types (prepare for future templates)
- [ ] Performance test template generation speed

### Success Criteria

1. **Single Source of Truth**: All infrastructure templates in `platform/infrastructure-templates/`
2. **No Duplication**: No duplicate infrastructure files across the codebase
3. **Platform Standards**: All generated infrastructure includes TLS, monitoring, security by default
4. **Template Flexibility**: Templates can provide language-specific optimizations
5. **Maintainability**: Infrastructure changes can be made in one place
6. **Testing**: Comprehensive test coverage for infrastructure generation
7. **Documentation**: Clear guidelines for template developers and platform maintainers

### Risks and Mitigations

#### Risk: Template Developer Resistance
**Mitigation**: Provide clear benefits, migration support, and extension mechanisms

#### Risk: Breaking Existing Templates
**Mitigation**: Comprehensive testing, gradual migration, backward compatibility

#### Risk: Reduced Template Flexibility
**Mitigation**: Well-designed extension points, template contribution system

#### Risk: Platform Team Bottleneck
**Mitigation**: Clear interfaces, automated validation, self-service capabilities

### Timeline

- **Week 1**: Audit and planning
- **Week 2**: Create consolidated template structure
- **Week 3**: Update Auto-Generator and testing
- **Week 4**: Migration and validation
- **Week 5**: Documentation and cleanup

This consolidation will provide a solid foundation for the "Simple by Default, Extensible by Choice" architecture while maintaining clear separation of concerns between platform infrastructure standards and template-specific optimizations.
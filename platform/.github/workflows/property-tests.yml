name: Property-Based Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run property tests nightly to catch rare edge cases
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: "3.11"
  HYPOTHESIS_PROFILE: ci

jobs:
  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      localstack:
        image: localstack/localstack:3.0
        ports:
          - 4566:4566
        env:
          SERVICES: s3,ecs,logs,ssm,ecr
          DEBUG: 1
          DATA_DIR: /tmp/localstack/data
          DOCKER_HOST: unix:///var/run/docker.sock
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: Install dependencies
      run: |
        cd platform
        uv sync --dev
        
    - name: Wait for LocalStack
      run: |
        timeout 60 bash -c 'until curl -s http://localhost:4566/_localstack/health | grep -q "running"; do sleep 2; done'
        
    - name: Configure Hypothesis for CI
      run: |
        cd platform
        mkdir -p .hypothesis
        cat > .hypothesis/settings.json << EOF
        {
          "ci": {
            "max_examples": 200,
            "deadline": 10000,
            "suppress_health_check": ["too_slow"]
          }
        }
        EOF
        
    - name: Run Property Test - Muppet Creation Completeness
      env:
        AWS_ENDPOINT_URL: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_DEFAULT_REGION: us-east-1
      run: |
        cd platform
        echo "Running Property 1: Muppet Creation Completeness"
        uv run python -m pytest tests/test_property_muppet_creation.py::test_muppet_creation_completeness -v --tb=short
        
    - name: Run Property Test - Muppet Deletion Cleanup
      env:
        AWS_ENDPOINT_URL: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_DEFAULT_REGION: us-east-1
      run: |
        cd platform
        echo "Running Property 2: Muppet Deletion Cleanup"
        uv run python -m pytest tests/test_property_muppet_creation.py::test_muppet_deletion_cleanup -v --tb=short
        
    - name: Run Property Test - Registry Consistency
      env:
        AWS_ENDPOINT_URL: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_DEFAULT_REGION: us-east-1
      run: |
        cd platform
        echo "Running Property 3: Registry Consistency"
        uv run python -m pytest tests/test_property_state_management.py::test_registry_consistency -v --tb=short
        
    - name: Run Property Test - MCP Authentication
      env:
        AWS_ENDPOINT_URL: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_DEFAULT_REGION: us-east-1
      run: |
        cd platform
        echo "Running Property 8: MCP Authentication"
        uv run python -m pytest tests/test_property_mcp_authentication.py::test_mcp_authentication -v --tb=short
        
    - name: Generate Property Test Report
      if: always()
      run: |
        cd platform
        echo "## Property-Based Test Results" > property_test_report.md
        echo "" >> property_test_report.md
        echo "| Property | Status | Examples Tested | Time |" >> property_test_report.md
        echo "|----------|--------|-----------------|------|" >> property_test_report.md
        
        # Parse test results and add to report
        if [ -f .hypothesis/examples/*/test_muppet_creation_completeness ]; then
          echo "| Muppet Creation Completeness | ✅ Passed | $(ls .hypothesis/examples/*/test_muppet_creation_completeness | wc -l) | - |" >> property_test_report.md
        else
          echo "| Muppet Creation Completeness | ❌ Failed | - | - |" >> property_test_report.md
        fi
        
        cat property_test_report.md
        
    - name: Upload Hypothesis examples
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: hypothesis-examples
        path: platform/.hypothesis/examples/
        retention-days: 7
        
    - name: Upload Property Test Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: property-test-report
        path: platform/property_test_report.md
        retention-days: 30

  property-stress-test:
    name: Property Stress Test
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    timeout-minutes: 60
    
    services:
      localstack:
        image: localstack/localstack:3.0
        ports:
          - 4566:4566
        env:
          SERVICES: s3,ecs,logs,ssm,ecr
          DEBUG: 1
          DATA_DIR: /tmp/localstack/data
          DOCKER_HOST: unix:///var/run/docker.sock
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: Install dependencies
      run: |
        cd platform
        uv sync --dev
        
    - name: Wait for LocalStack
      run: |
        timeout 60 bash -c 'until curl -s http://localhost:4566/_localstack/health | grep -q "running"; do sleep 2; done'
        
    - name: Configure Hypothesis for stress testing
      run: |
        cd platform
        mkdir -p .hypothesis
        cat > .hypothesis/settings.json << EOF
        {
          "stress": {
            "max_examples": 1000,
            "deadline": 30000,
            "suppress_health_check": ["too_slow", "data_too_large"]
          }
        }
        EOF
        
    - name: Run stress property tests
      env:
        AWS_ENDPOINT_URL: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_DEFAULT_REGION: us-east-1
        HYPOTHESIS_PROFILE: stress
      run: |
        cd platform
        uv run python -m pytest tests/test_property_*.py -v --tb=short
        
    - name: Upload stress test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: stress-test-examples
        path: platform/.hypothesis/examples/
        retention-days: 14
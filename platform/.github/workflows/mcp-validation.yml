name: MCP Server Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'platform/src/platform_mcp/**'
      - 'platform/tests/test_mcp_*.py'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'platform/src/platform_mcp/**'
      - 'platform/tests/test_mcp_*.py'

env:
  PYTHON_VERSION: "3.10"

jobs:
  validate-mcp:
    name: Validate MCP Server
    runs-on: ubuntu-latest
    
    services:
      localstack:
        image: localstack/localstack:3.0
        ports:
          - 4566:4566
        env:
          SERVICES: s3,ecs,logs,ssm,ecr
          DEBUG: 1
          DATA_DIR: /tmp/localstack/data
          DOCKER_HOST: unix:///var/run/docker.sock
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: Install dependencies
      run: |
        cd platform
        uv sync --dev
        
    - name: Wait for LocalStack
      run: |
        timeout 60 bash -c 'until curl -s http://localhost:4566/_localstack/health | grep -q "running"; do sleep 2; done'
        
    - name: Test MCP server startup
      env:
        AWS_ENDPOINT_URL: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_DEFAULT_REGION: us-east-1
      run: |
        cd platform
        timeout 30 uv run python -m src.platform_mcp.cli &
        MCP_PID=$!
        sleep 5
        kill $MCP_PID || true
        
    - name: Run MCP-specific tests
      env:
        AWS_ENDPOINT_URL: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_DEFAULT_REGION: us-east-1
      run: |
        cd platform
        uv run python -m pytest tests/test_mcp_*.py -v --tb=short
        
    - name: Test MCP tool discovery
      env:
        AWS_ENDPOINT_URL: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_DEFAULT_REGION: us-east-1
      run: |
        cd platform
        uv run python -c "
        from src.platform_mcp.tools import get_available_tools
        tools = get_available_tools()
        expected_tools = ['create_muppet', 'delete_muppet', 'list_muppets', 'get_muppet_status', 'get_muppet_logs', 'list_templates', 'setup_muppet_dev', 'update_shared_steering', 'list_steering_docs']
        missing = set(expected_tools) - set(tool.name for tool in tools)
        if missing:
            print(f'Missing MCP tools: {missing}')
            exit(1)
        print(f'All {len(tools)} MCP tools discovered successfully')
        "
        
    - name: Validate MCP tool schemas
      env:
        AWS_ENDPOINT_URL: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_DEFAULT_REGION: us-east-1
      run: |
        cd platform
        uv run python -c "
        from src.platform_mcp.tools import get_available_tools
        import json
        
        for tool in get_available_tools():
            try:
                # Validate that each tool has proper schema
                assert hasattr(tool, 'name'), f'Tool {tool} missing name'
                assert hasattr(tool, 'description'), f'Tool {tool.name} missing description'
                assert hasattr(tool, 'inputSchema'), f'Tool {tool.name} missing inputSchema'
                
                # Validate schema is valid JSON Schema
                schema = tool.inputSchema
                assert 'type' in schema, f'Tool {tool.name} schema missing type'
                assert 'properties' in schema, f'Tool {tool.name} schema missing properties'
                
                print(f'✅ Tool {tool.name} schema valid')
            except Exception as e:
                print(f'❌ Tool {tool.name} schema invalid: {e}')
                exit(1)
        
        print('All MCP tool schemas are valid')
        "

  integration-test:
    name: MCP Integration Test
    runs-on: ubuntu-latest
    needs: validate-mcp
    
    services:
      localstack:
        image: localstack/localstack:3.0
        ports:
          - 4566:4566
        env:
          SERVICES: s3,ecs,logs,ssm,ecr
          DEBUG: 1
          DATA_DIR: /tmp/localstack/data
          DOCKER_HOST: unix:///var/run/docker.sock
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: Install dependencies
      run: |
        cd platform
        uv sync --dev
        
    - name: Wait for LocalStack
      run: |
        timeout 60 bash -c 'until curl -s http://localhost:4566/_localstack/health | grep -q "running"; do sleep 2; done'
        
    - name: Start platform service
      env:
        AWS_ENDPOINT_URL: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_DEFAULT_REGION: us-east-1
        LOG_LEVEL: INFO
      run: |
        cd platform
        uv run python -m uvicorn src.main:app --host 0.0.0.0 --port 8000 &
        PLATFORM_PID=$!
        echo "PLATFORM_PID=$PLATFORM_PID" >> $GITHUB_ENV
        sleep 10
        
    - name: Start MCP server
      env:
        AWS_ENDPOINT_URL: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_DEFAULT_REGION: us-east-1
        PLATFORM_URL: http://localhost:8000
      run: |
        cd platform
        uv run python -m src.platform_mcp.cli &
        MCP_PID=$!
        echo "MCP_PID=$MCP_PID" >> $GITHUB_ENV
        sleep 5
        
    - name: Test MCP-Platform integration
      env:
        AWS_ENDPOINT_URL: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_DEFAULT_REGION: us-east-1
        PLATFORM_URL: http://localhost:8000
      run: |
        cd platform
        uv run python -m pytest tests/test_mcp_integration.py -v --tb=short
        
    - name: Cleanup processes
      if: always()
      run: |
        kill ${{ env.MCP_PID }} || true
        kill ${{ env.PLATFORM_PID }} || true
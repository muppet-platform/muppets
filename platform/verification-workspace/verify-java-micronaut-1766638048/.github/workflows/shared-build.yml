name: Shared Java Build Workflow

on:
  workflow_call:
    inputs:
      java_version:
        description: 'Java version to use'
        required: false
        type: string
        default: '21'
      java_distribution:
        description: 'Java distribution to use'
        required: false
        type: string
        default: 'corretto'
      ecr_repository:
        description: 'ECR repository name'
        required: true
        type: string
      aws_region:
        description: 'AWS region'
        required: false
        type: string
        default: 'us-east-1'
      build_args:
        description: 'Additional Docker build arguments'
        required: false
        type: string
        default: ''
      gradle_cache_key_suffix:
        description: 'Additional suffix for Gradle cache key'
        required: false
        type: string
        default: ''
    outputs:
      image_uri:
        description: 'Full URI of the built Docker image'
        value: ${{ jobs.build.outputs.image_uri }}
      image_tag:
        description: 'Tag of the built Docker image'
        value: ${{ jobs.build.outputs.image_tag }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.build-image.outputs.image_uri }}
      image_tag: ${{ github.sha }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Amazon Corretto JDK ${{ inputs.java_version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ inputs.java_version }}
        distribution: ${{ inputs.java_distribution }}
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}${{ inputs.gradle_cache_key_suffix }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Make gradlew executable
      run: chmod +x ./gradlew
      
    - name: Validate Java version (LTS enforcement)
      run: |
        JAVA_VERSION=$(java -version 2>&1 | head -n 1 | cut -d'"' -f2 | cut -d'.' -f1)
        echo "Detected Java version: $JAVA_VERSION"
        if [ "$JAVA_VERSION" -ne 21 ]; then
          echo "âŒ Java 21 LTS required, found Java $JAVA_VERSION"
          if [ "$JAVA_VERSION" -gt 21 ]; then
            echo "âš ï¸  Java $JAVA_VERSION is newer than Java 21 LTS and may cause compatibility issues"
            echo "   Non-LTS Java versions are not supported in production environments"
          fi
          exit 1
        fi
        java -version 2>&1 | grep -q "21.*LTS" && echo "âœ… Java 21 LTS detected" || echo "âŒ Non-LTS Java version detected"
      
    - name: Build application
      run: ./gradlew shadowJar --no-daemon
      
    - name: Verify JAR file
      run: |
        JAR_FILE=$(find build/libs -name "*-all.jar" | head -1)
        if [ -z "$JAR_FILE" ]; then
          echo "âŒ Shadow JAR not found in build/libs/"
          ls -la build/libs/
          exit 1
        fi
        echo "âœ… Shadow JAR found: $JAR_FILE"
        echo "JAR size: $(du -h "$JAR_FILE" | cut -f1)"
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ inputs.aws_region }}
        
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ inputs.ecr_repository }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Build Docker image with build args if provided
        BUILD_ARGS=""
        if [ -n "${{ inputs.build_args }}" ]; then
          BUILD_ARGS="${{ inputs.build_args }}"
        fi
        
        echo "Building Docker image..."
        docker build $BUILD_ARGS -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        echo "Pushing Docker image..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        # Output image URI for downstream jobs
        IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
        echo "âœ… Image pushed: $IMAGE_URI"
        
    - name: Scan image for vulnerabilities
      continue-on-error: true
      run: |
        # Install Trivy
        sudo apt-get update
        sudo apt-get install wget apt-transport-https gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install trivy
        
        # Scan the image
        trivy image --exit-code 0 --severity HIGH,CRITICAL ${{ steps.login-ecr.outputs.registry }}/${{ inputs.ecr_repository }}:${{ github.sha }}
        
    - name: Generate build summary
      run: |
        echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Java Version**: ${{ inputs.java_version }} (${{ inputs.java_distribution }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Image URI**: ${{ steps.build-image.outputs.image_uri }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Tag**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ECR Repository**: ${{ inputs.ecr_repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **AWS Region**: ${{ inputs.aws_region }}" >> $GITHUB_STEP_SUMMARY
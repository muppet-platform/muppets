name: Shared Java Deploy Workflow

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (staging/production)'
        required: true
        type: string
      muppet_name:
        description: 'Name of the muppet being deployed'
        required: true
        type: string
      aws_region:
        description: 'AWS region'
        required: false
        type: string
        default: 'us-east-1'
      image_uri:
        description: 'Docker image URI to deploy'
        required: true
        type: string
      opentofu_version:
        description: 'OpenTofu version to use'
        required: false
        type: string
        default: '1.6.0'
      terraform_dir:
        description: 'Directory containing Terraform/OpenTofu files'
        required: false
        type: string
        default: './terraform'
      auto_approve:
        description: 'Auto-approve OpenTofu apply'
        required: false
        type: boolean
        default: false
    outputs:
      deployment_url:
        description: 'URL of the deployed application'
        value: ${{ jobs.deploy.outputs.deployment_url }}
      service_arn:
        description: 'ARN of the deployed ECS service'
        value: ${{ jobs.deploy.outputs.service_arn }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      deployment_url: ${{ steps.deploy-infra.outputs.deployment_url }}
      service_arn: ${{ steps.deploy-infra.outputs.service_arn }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ inputs.aws_region }}
        
    - name: Setup OpenTofu
      uses: opentofu/setup-opentofu@v1
      with:
        tofu_version: ${{ inputs.opentofu_version }}
        
    - name: Validate deployment environment
      run: |
        if [[ "${{ inputs.environment }}" != "staging" && "${{ inputs.environment }}" != "production" ]]; then
          echo "âŒ Invalid environment: ${{ inputs.environment }}. Must be 'staging' or 'production'"
          exit 1
        fi
        echo "âœ… Deploying to environment: ${{ inputs.environment }}"
        
    - name: OpenTofu Init
      working-directory: ${{ inputs.terraform_dir }}
      run: |
        tofu init
        tofu workspace select ${{ inputs.environment }} || tofu workspace new ${{ inputs.environment }}
      
    - name: OpenTofu Plan
      id: plan
      working-directory: ${{ inputs.terraform_dir }}
      run: |
        tofu plan \
          -var="muppet_name=${{ inputs.muppet_name }}" \
          -var="aws_region=${{ inputs.aws_region }}" \
          -var="environment=${{ inputs.environment }}" \
          -var="image_uri=${{ inputs.image_uri }}" \
          -out=tfplan
          
    - name: OpenTofu Plan Summary
      working-directory: ${{ inputs.terraform_dir }}
      run: |
        echo "## ðŸš€ Deployment Plan for ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Muppet**: ${{ inputs.muppet_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: ${{ inputs.image_uri }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Region**: ${{ inputs.aws_region }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Plan Output" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        tofu show -no-color tfplan | head -50 >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
          
    - name: OpenTofu Apply
      id: deploy-infra
      working-directory: ${{ inputs.terraform_dir }}
      run: |
        if [ "${{ inputs.auto_approve }}" = "true" ]; then
          tofu apply -auto-approve tfplan
        else
          tofu apply tfplan
        fi
        
        # Extract outputs
        DEPLOYMENT_URL=$(tofu output -raw deployment_url 2>/dev/null || echo "")
        SERVICE_ARN=$(tofu output -raw service_arn 2>/dev/null || echo "")
        
        echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
        echo "service_arn=$SERVICE_ARN" >> $GITHUB_OUTPUT
        
        if [ -n "$DEPLOYMENT_URL" ]; then
          echo "âœ… Deployment successful: $DEPLOYMENT_URL"
        fi
        
    - name: Wait for service to be stable
      run: |
        if [ -n "${{ steps.deploy-infra.outputs.service_arn }}" ]; then
          echo "Waiting for ECS service to stabilize..."
          aws ecs wait services-stable \
            --cluster $(echo "${{ steps.deploy-infra.outputs.service_arn }}" | cut -d'/' -f2) \
            --services $(echo "${{ steps.deploy-infra.outputs.service_arn }}" | cut -d'/' -f3) \
            --region ${{ inputs.aws_region }}
          echo "âœ… Service is stable"
        fi
        
    - name: Health check
      if: steps.deploy-infra.outputs.deployment_url != ''
      run: |
        DEPLOYMENT_URL="${{ steps.deploy-infra.outputs.deployment_url }}"
        if [ -n "$DEPLOYMENT_URL" ]; then
          echo "Performing health check on $DEPLOYMENT_URL/health"
          
          # Wait up to 5 minutes for the service to be healthy
          for i in {1..30}; do
            if curl -f -s "$DEPLOYMENT_URL/health" > /dev/null; then
              echo "âœ… Health check passed"
              break
            else
              echo "Health check attempt $i/30 failed, waiting 10 seconds..."
              sleep 10
            fi
            
            if [ $i -eq 30 ]; then
              echo "âŒ Health check failed after 5 minutes"
              exit 1
            fi
          done
        fi
        
    - name: Deployment Summary
      run: |
        echo "## âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Muppet**: ${{ inputs.muppet_name }}" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ steps.deploy-infra.outputs.deployment_url }}" ]; then
          echo "- **URL**: ${{ steps.deploy-infra.outputs.deployment_url }}" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -n "${{ steps.deploy-infra.outputs.service_arn }}" ]; then
          echo "- **Service ARN**: ${{ steps.deploy-infra.outputs.service_arn }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Deployed at**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
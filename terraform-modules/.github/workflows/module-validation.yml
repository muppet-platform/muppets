name: OpenTofu Module Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  TOFU_VERSION: "1.6.0"
  AWS_DEFAULT_REGION: us-east-1

jobs:
  validate-modules:
    name: Validate OpenTofu Modules
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        module:
          - ecr
          - fargate-service
          - iam
          - monitoring
          - networking
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup OpenTofu
      uses: opentofu/setup-opentofu@v1
      with:
        tofu_version: ${{ env.TOFU_VERSION }}
        
    - name: Validate module syntax
      run: |
        cd terraform-modules/${{ matrix.module }}
        echo "Validating ${{ matrix.module }} module..."
        
        # Initialize without backend
        tofu init -backend=false
        
        # Validate syntax and configuration
        tofu validate
        
        # Check formatting
        tofu fmt -check=true -diff=true
        
        echo "✅ ${{ matrix.module }} module validation passed"
        
    - name: Check required files
      run: |
        cd terraform-modules/${{ matrix.module }}
        
        required_files=("main.tf" "variables.tf" "outputs.tf" "README.md")
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ Missing required file: $file"
            exit 1
          fi
        done
        
        echo "✅ All required files present in ${{ matrix.module }}"
        
    - name: Validate module documentation
      run: |
        cd terraform-modules/${{ matrix.module }}
        
        # Check README.md has required sections
        if ! grep -q "## Usage" README.md; then
          echo "❌ README.md missing Usage section"
          exit 1
        fi
        
        if ! grep -q "## Variables" README.md; then
          echo "❌ README.md missing Variables section"
          exit 1
        fi
        
        if ! grep -q "## Outputs" README.md; then
          echo "❌ README.md missing Outputs section"
          exit 1
        fi
        
        echo "✅ ${{ matrix.module }} documentation is complete"
        
    - name: Check for version constraints
      run: |
        cd terraform-modules/${{ matrix.module }}
        
        # Check if versions.tf exists or version constraints are in main.tf
        if [ -f "versions.tf" ]; then
          version_file="versions.tf"
        elif grep -q "required_version" main.tf; then
          version_file="main.tf"
        else
          echo "❌ No OpenTofu version constraints found"
          exit 1
        fi
        
        # Check for minimum OpenTofu version
        if ! grep -q "required_version.*>=.*1\.[5-9]" "$version_file"; then
          echo "❌ OpenTofu version constraint should be >= 1.5"
          exit 1
        fi
        
        echo "✅ ${{ matrix.module }} has proper version constraints"

  security-scan:
    name: Security Scan Modules
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Checkov security scan
      uses: bridgecrewio/checkov-action@master
      with:
        directory: terraform-modules/
        framework: terraform
        output_format: sarif
        output_file_path: checkov-results.sarif
        
    - name: Upload Checkov scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: checkov-results.sarif
        
    - name: Run TFSec security scanner
      uses: aquasecurity/tfsec-action@v1.0.3
      with:
        working_directory: terraform-modules/
        format: sarif
        
    - name: Upload TFSec scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: tfsec.sarif

  test-modules:
    name: Test OpenTofu Modules
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    services:
      localstack:
        image: localstack/localstack:3.0
        ports:
          - 4566:4566
        env:
          SERVICES: s3,ecs,logs,ssm,ecr,elbv2,ec2,iam
          DEBUG: 1
          DATA_DIR: /tmp/localstack/data
          DOCKER_HOST: unix:///var/run/docker.sock
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
    
    strategy:
      matrix:
        module:
          - ecr
          - fargate-service
          - iam
          - monitoring
          - networking
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup OpenTofu
      uses: opentofu/setup-opentofu@v1
      with:
        tofu_version: ${{ env.TOFU_VERSION }}
        
    - name: Wait for LocalStack
      run: |
        timeout 60 bash -c 'until curl -s http://localhost:4566/_localstack/health | grep -q "running"; do sleep 2; done'
        
    - name: Test module with LocalStack
      env:
        AWS_ENDPOINT_URL: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_DEFAULT_REGION: us-east-1
      run: |
        cd terraform-modules/${{ matrix.module }}
        
        # Create a test configuration
        cat > test.tf << EOF
        terraform {
          required_providers {
            aws = {
              source  = "hashicorp/aws"
              version = "~> 5.0"
            }
          }
        }
        
        provider "aws" {
          region                      = "us-east-1"
          access_key                  = "test"
          secret_key                  = "test"
          skip_credentials_validation = true
          skip_metadata_api_check     = true
          skip_requesting_account_id  = true
          
          endpoints {
            s3       = "http://localhost:4566"
            ecs      = "http://localhost:4566"
            logs     = "http://localhost:4566"
            ssm      = "http://localhost:4566"
            ecr      = "http://localhost:4566"
            elbv2    = "http://localhost:4566"
            ec2      = "http://localhost:4566"
            iam      = "http://localhost:4566"
          }
        }
        
        module "test_${{ matrix.module }}" {
          source = "./"
          
          # Add minimal required variables for each module
        EOF
        
        # Add module-specific test variables
        case "${{ matrix.module }}" in
          "ecr")
            cat >> test.tf << EOF
          repository_name = "test-repo"
        }
        EOF
            ;;
          "fargate-service")
            cat >> test.tf << EOF
          service_name = "test-service"
          cluster_name = "test-cluster"
          image_uri = "nginx:latest"
          vpc_id = "vpc-12345"
          subnet_ids = ["subnet-12345"]
        }
        EOF
            ;;
          "iam")
            cat >> test.tf << EOF
          service_name = "test-service"
        }
        EOF
            ;;
          "monitoring")
            cat >> test.tf << EOF
          service_name = "test-service"
          cluster_name = "test-cluster"
        }
        EOF
            ;;
          "networking")
            cat >> test.tf << EOF
          vpc_name = "test-vpc"
          environment = "test"
        }
        EOF
            ;;
        esac
        
        # Initialize and plan
        tofu init
        tofu plan -out=test.tfplan
        
        echo "✅ ${{ matrix.module }} module test passed"

  validate-module-dependencies:
    name: Validate Module Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup OpenTofu
      uses: opentofu/setup-opentofu@v1
      with:
        tofu_version: ${{ env.TOFU_VERSION }}
        
    - name: Check module interdependencies
      run: |
        echo "Checking module interdependencies..."
        
        # Create a test configuration that uses all modules together
        mkdir -p test-integration
        cd test-integration
        
        cat > main.tf << EOF
        terraform {
          required_providers {
            aws = {
              source  = "hashicorp/aws"
              version = "~> 5.0"
            }
          }
        }
        
        provider "aws" {
          region = "us-east-1"
        }
        
        # Test module integration
        module "networking" {
          source = "../networking"
          
          vpc_name = "test-vpc"
          environment = "test"
        }
        
        module "ecr" {
          source = "../ecr"
          
          repository_name = "test-repo"
        }
        
        module "iam" {
          source = "../iam"
          
          service_name = "test-service"
        }
        
        module "monitoring" {
          source = "../monitoring"
          
          service_name = "test-service"
          cluster_name = "test-cluster"
        }
        
        module "fargate_service" {
          source = "../fargate-service"
          
          service_name = "test-service"
          cluster_name = "test-cluster"
          image_uri = module.ecr.repository_url
          vpc_id = module.networking.vpc_id
          subnet_ids = module.networking.private_subnet_ids
          
          depends_on = [
            module.networking,
            module.ecr,
            module.iam
          ]
        }
        EOF
        
        # Initialize and validate integration
        tofu init -backend=false
        tofu validate
        
        echo "✅ Module integration validation passed"

  check-module-versions:
    name: Check Module Versions
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for version tags
      run: |
        echo "Checking module versioning..."
        
        # Check if modules have version tags in git
        for module_dir in terraform-modules/*/; do
          if [ -d "$module_dir" ] && [ "$(basename "$module_dir")" != "tests" ]; then
            module_name=$(basename "$module_dir")
            
            # Check for version tags for this module
            version_tags=$(git tag -l "${module_name}-v*" | wc -l)
            
            if [ "$version_tags" -eq 0 ]; then
              echo "⚠️  No version tags found for $module_name"
            else
              latest_tag=$(git tag -l "${module_name}-v*" | sort -V | tail -n1)
              echo "✅ $module_name latest version: $latest_tag"
            fi
          fi
        done
        
    - name: Validate semantic versioning
      run: |
        echo "Validating semantic versioning..."
        
        # Check that all version tags follow semantic versioning
        invalid_tags=()
        
        for tag in $(git tag -l "*-v*"); do
          version=$(echo "$tag" | sed 's/.*-v//')
          
          # Check if version matches semantic versioning pattern
          if ! echo "$version" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            invalid_tags+=("$tag")
          fi
        done
        
        if [ ${#invalid_tags[@]} -gt 0 ]; then
          echo "❌ Invalid version tags found:"
          for tag in "${invalid_tags[@]}"; do
            echo "  $tag"
          done
          exit 1
        else
          echo "✅ All version tags follow semantic versioning"
        fi